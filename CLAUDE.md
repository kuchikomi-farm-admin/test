# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

TheJapanLocalMedia — an invitation-only closed media platform (Japanese-first UI). Supabase (Auth/DB/Storage) + Next.js App Router. Zustand stores are being migrated to Supabase-backed Server Actions.

## Commands

```bash
npm run dev      # Start dev server (port 3000)
npm run build    # Production build (note: TS errors are ignored in next.config.mjs)
npm run lint     # ESLint (Next.js defaults, no custom rules)
npm run start    # Start production server
```

No test framework is configured.

## Tech Stack

- **Next.js 16** with App Router, **React 19**, **TypeScript** (strict mode)
- **Supabase** (Auth, PostgreSQL, Storage, RLS)
- **shadcn/ui** (Radix UI primitives) — 45+ components in `components/ui/`
- **Tailwind CSS** with class-based dark mode, `tailwindcss-animate` plugin
- **Zustand** for client-side state (being migrated to Supabase)
- **Zod** for validation (client + server)
- **Recharts** for admin dashboard charts
- **Lucide React** for icons

## Architecture

### Routing (App Router)

All pages are client components (`"use client"`). Routes:

- `/` — Login page
- `/signup?ref=CODE` — Registration (via invite link, ref param required)
- `/signup/complete` — OAuth post-registration screening question
- `/feed` — Main content feed (articles, videos, external links)
- `/article/[id]` — Article detail (dynamic route, uses `use()` hook for params)
- `/mypage` — User profile & referral dashboard (permanent invite link)
- `/settings` — Account settings (profile, password, notifications)
- `/admin` — Admin dashboard (tabs: overview, content, users, rewards, broadcasts)
- `/auth/callback` — Supabase email verification callback

### Auth Flow (2-gate system)

1. Invite link access (`/signup?ref=CODE`) → 2. Email confirmation → 3. Admin approval (pending → active)

- `middleware.ts` — Route guard (public paths: `/`, `/signup`, `/signup/complete`, `/auth/callback`, `/auth/reset-callback`, `/reset-password`)
- `lib/supabase/auth-provider.tsx` — Syncs Supabase auth state to Zustand store
- `app/actions/auth.ts` — Server Actions: signUp, signIn, signOut, changePassword, verifyInviteCode
- `app/actions/profile.ts` — Server Actions: updateProfile, getNotificationPreferences, etc.

### Supabase Clients

- `lib/supabase/client.ts` — Browser client (anon key)
- `lib/supabase/server.ts` — Server Actions client (cookie-based)
- `lib/supabase/admin.ts` — Admin client (service role key)

### State Management (`lib/store/`)

| Store | Key | Purpose |
|---|---|---|
| `useUserStore` | (no persist) | Auth state from Supabase via AuthProvider |
| `useContentStore` | `tjm-content-storage` | Articles/videos/external content |
| `useAdminStore` | `tjm-admin-storage` | Dashboard stats & growth data |
| `useAdminUserStore` | `tjm-admin-user-storage` | Admin user management |
| `useBroadcastStore` | `tjm-broadcast-storage` | Push notification broadcasts |
| `useRewardStore` | `tjm-reward-storage` | Reward tiers & config |

### Hydration Pattern

All client pages guard against SSR/client mismatch with:
```tsx
const [mounted, setMounted] = useState(false)
useEffect(() => setMounted(true), [])
if (!mounted) return null
```

### Key Directories

- `components/ui/` — shadcn/ui primitives (do not edit manually; use `npx shadcn@latest add`)
- `components/admin/` — Admin dashboard feature components
- `lib/types.ts` — Shared TypeScript interfaces and enums (ContentType, MemberRank, etc.)
- `lib/supabase/database.types.ts` — Supabase DB type definitions
- `lib/validations/` — Zod schemas (auth.ts, profile.ts)
- `supabase/migrations/` — SQL migration files (00001–00006)

## Conventions

- **Path alias:** `@/*` maps to project root
- **File naming:** kebab-case for all files
- **Component naming:** PascalCase
- **Fonts:** Noto Sans JP (default), Noto Serif JP (serif) — loaded via `next/font/google`
- **Color scheme:** Dark green (#1B3022), Gold (#D4AF37), Light neutral (#F8F9FA) defined as CSS variables
- **Content access levels:** all, standard, gold, platinum, diamond (enum `MemberRank`)
- **Member ID prefix:** `JK-` (auto-generated by DB trigger)
- **RLS admin check:** Use `is_admin()` function (security definer) to avoid recursion
