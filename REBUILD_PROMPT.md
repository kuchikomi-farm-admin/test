# TheJapanLocalMedia â€” æ–°è¦æ§‹ç¯‰ å®Œå…¨æ‰‹é †æ›¸

> **ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¤ã„ã¦**
> ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ãªã„æ–¹ã§ã‚‚ã€ã“ã®æ‰‹é †æ›¸ã‚’ä¸Šã‹ã‚‰é †ç•ªã«å®Ÿè¡Œã™ã‚Œã°
> `kuchikomi-farm.com` ã§ã‚µãƒ¼ãƒ“ã‚¹ã‚’å…¬é–‹ã§ãã‚‹ã‚ˆã†ã«æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚
> Claude Codeã¸ã®é–‹ç™ºä¾é ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚‚å«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

---

## â± å…¨ä½“ã®ä½œæ¥­æ™‚é–“ã®ç›®å®‰

| ãƒ•ã‚§ãƒ¼ã‚º | å†…å®¹ | ç›®å®‰æ™‚é–“ |
|---------|------|---------|
| STEP 1 | ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ | ç´„2ã€œ3æ™‚é–“ |
| STEP 2 | Claude Codeã«é–‹ç™ºä¾é ¼ | ç´„3ã€œ5æ™‚é–“ï¼ˆAIãŒä½œæ¥­ï¼‰ |
| STEP 3 | Vercelã§å…¬é–‹ãƒ»å‹•ä½œç¢ºèª | ç´„1æ™‚é–“ |

---

## ğŸ“‹ å…¨ä½“ã®æµã‚Œ

```
GitHub        â†’ ã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜ã™ã‚‹å ´æ‰€ã‚’ä½œã‚‹
Namecheap     â†’ kuchikomi-farm.com ã‚’è²·ã†
Cloudflare    â†’ ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ã‚µãƒ¼ãƒ“ã‚¹ã«ç¹‹ã’ã‚‹
Supabase      â†’ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆä¼šå“¡æƒ…å ±ãƒ»è¨˜äº‹ãªã©ï¼‰ã‚’ä½œã‚‹
Clerk         â†’ ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ä¼šå“¡ç™»éŒ²ã®ä»•çµ„ã¿ã‚’ä½œã‚‹
Resend        â†’ ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ãƒ¡ãƒ¼ãƒ«ã‚’é€ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
Upstash       â†’ ã‚¢ã‚¯ã‚»ã‚¹é€Ÿåº¦æ”¹å–„ãƒ»ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹å¯¾ç­–
PostHog       â†’ ã€Œã©ã‚“ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã©ã®ãƒšãƒ¼ã‚¸ã‚’è¦‹ãŸã‹ã€ã‚’è¨ˆæ¸¬
Sentry        â†’ ã‚¨ãƒ©ãƒ¼ãŒèµ·ããŸã¨ãè‡ªå‹•ã§é€šçŸ¥ã—ã¦ã‚‚ã‚‰ã†
Vercel        â†’ ä½œã£ãŸã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«å…¬é–‹ã™ã‚‹
                  â†“
          Claude Codeã§é–‹ç™º â†’ å…¬é–‹å®Œäº†ï¼
```

---

## ğŸ”‘ ãƒ¡ãƒ¢å¸³ï¼ˆä½œæ¥­å‰ã«å°åˆ·ã¾ãŸã¯ãƒ¡ãƒ¢å¸³ã‚’ç”¨æ„ã—ã¦ãã ã•ã„ï¼‰

ä½œæ¥­ä¸­ã«å‡ºã¦ãã‚‹ã€Œã‚­ãƒ¼ã€ã‚„ã€ŒURLã€ã‚’ã“ã“ã«æ›¸ãè¾¼ã‚“ã§ãã ã•ã„ã€‚
**ã“ã‚Œã‚‰ã¯çµ¶å¯¾ã«ä»–äººã«è¦‹ã›ãªã„ã§ãã ã•ã„ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨åŒã˜ã§ã™ï¼‰ã€‚**

```
ã€GitHubã€‘
  ãƒªãƒã‚¸ãƒˆãƒªURL: https://github.com/___________/japan-local-media

ã€Supabaseã€‘
  Project URL:          https://____________.supabase.co
  anon public ã‚­ãƒ¼:     eyJ_______________
  service_role ã‚­ãƒ¼:    eyJ_______________ â† ç‰¹ã«å³é‡ã«ç®¡ç†ï¼

ã€Clerkã€‘
  Publishable Key:      pk_live___________
  Secret Key:           sk_live___________ â† å³é‡ã«ç®¡ç†ï¼
  Webhook Secret:       whsec_____________

ã€Resendã€‘
  API Key:              re________________

ã€Upstash Redisã€‘
  REST URL:             https://___________
  REST Token:           ___________________

ã€PostHogã€‘
  Project API Key:      phc________________
  Host URL:             https://us.posthog.com

ã€Sentryã€‘
  DSN:                  https://___@___.ingest.sentry.io/___

ã€Vercelã€‘
  å…¬é–‹URLï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤å¾Œï¼‰: https://kuchikomi-farm.com
```

---

## STEP 1: ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œã‚‹

> ğŸ’¡ **ãƒã‚¤ãƒ³ãƒˆ**: å…¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’**ã“ã®é †ç•ªé€šã‚Šã«**ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚
> å¾Œã®ã‚µãƒ¼ãƒ“ã‚¹ãŒå‰ã®ã‚µãƒ¼ãƒ“ã‚¹ã®æƒ…å ±ã‚’ä½¿ã†ã“ã¨ãŒã‚ã‚‹ãŸã‚ã§ã™ã€‚

---

### 1-1. GitHubï¼ˆã‚³ãƒ¼ãƒ‰ã®ä¿ç®¡å ´æ‰€ï¼‰
> **ä½•ã®ãŸã‚ï¼Ÿ** ä½œã£ãŸãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ä¿å­˜ãƒ»ç®¡ç†ã™ã‚‹å ´æ‰€ã§ã™ã€‚
> Googleãƒ‰ãƒ©ã‚¤ãƒ–ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ç‰ˆã¨æ€ã£ã¦ãã ã•ã„ã€‚
> **è²»ç”¨:** ç„¡æ–™

**æ‰‹é †:**
1. https://github.com ã‚’é–‹ã
2. å³ä¸Šã®ã€Œ**Sign up**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
3. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ç™»éŒ²
4. å±Šã„ãŸãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãƒ¡ãƒ¼ãƒ«èªè¨¼ã‚’å®Œäº†
5. ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€å³ä¸Šã®ã€Œ**+**ã€â†’ã€Œ**New repository**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
6. ä»¥ä¸‹ã‚’å…¥åŠ›:
   - Repository name: `japan-local-media`
   - â—‹ **Private**ï¼ˆéå…¬é–‹ï¼‰ã‚’é¸æŠ
7. ã€Œ**Create repository**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
8. è¡¨ç¤ºã•ã‚ŒãŸãƒšãƒ¼ã‚¸ã®URLï¼ˆä¾‹: `https://github.com/ã‚ãªãŸã®ID/japan-local-media`ï¼‰ã‚’ãƒ¡ãƒ¢å¸³ã«è¨˜éŒ²

âœ… GitHubã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆå®Œäº†

---

### 1-2. Namecheapï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³å–å¾—ï¼‰
> **ä½•ã®ãŸã‚ï¼Ÿ** `kuchikomi-farm.com` ã¨ã„ã†URLã‚’è³¼å…¥ã™ã‚‹å ´æ‰€ã§ã™ã€‚
> ã“ã®URLãŒãªã„ã¨ã€è‡ªåˆ†ã®ã‚µãƒ¼ãƒ“ã‚¹ã«ã€Œä½æ‰€ã€ãŒãªã„çŠ¶æ…‹ã«ãªã‚Šã¾ã™ã€‚
> **è²»ç”¨:** ç´„Â¥1,800ã€œÂ¥2,500/å¹´ï¼ˆå¹´1å›æ‰•ã„ï¼‰

**æ‰‹é †:**
1. https://www.namecheap.com ã‚’é–‹ã
2. å³ä¸Šã€Œ**Sign Up**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
3. åå‰ãƒ»ãƒ¡ãƒ¼ãƒ«ãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ç™»éŒ² â†’ ãƒ¡ãƒ¼ãƒ«èªè¨¼
4. ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€æ¤œç´¢ãƒãƒ¼ã« `japanlocalmedia` ã¨å…¥åŠ›ã—ã¦ã€Œ**Search**ã€
5. `kuchikomi-farm.com` ãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰ã€Œ**Add to Cart**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
   - âš ï¸ `.com` ãŒæ—¢ã«å–å¾—æ¸ˆã¿ã®å ´åˆã¯ `.jp` ã‚„ `.net` ã‚‚æ¤œè¨
6. ã‚«ãƒ¼ãƒˆã‚’ç¢ºèª â†’ ã€Œ**Confirm Order**ã€â†’ æ”¯æ‰•ã„æƒ…å ±ã‚’å…¥åŠ›ã—ã¦è³¼å…¥
7. è³¼å…¥å®Œäº†å¾Œã€ã€Œ**Domain List**ã€ã§ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

> ğŸ“ ãƒ¡ãƒ¢: å–å¾—ã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³åï¼ˆ`kuchikomi-farm.com`ï¼‰ã‚’è¨˜éŒ²ã—ã¦ãŠã

âœ… ãƒ‰ãƒ¡ã‚¤ãƒ³å–å¾—å®Œäº†

---

### 1-3. Cloudflareï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³ã®ç¹‹ãå½¹ï¼‰
> **ä½•ã®ãŸã‚ï¼Ÿ** è²·ã£ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆkuchikomi-farm.comï¼‰ã‚’
> å®Ÿéš›ã®ã‚µãƒ¼ãƒãƒ¼ï¼ˆVercelï¼‰ã«ç¹‹ããŸã‚ã®ã€Œé›»è©±å¸³ã€çš„ãªå½¹å‰²ã‚’æ‹…ã„ã¾ã™ã€‚
> ã•ã‚‰ã«ã€æ‚ªæ„ã®ã‚ã‚‹ã‚¢ã‚¯ã‚»ã‚¹ã‹ã‚‰ã‚µã‚¤ãƒˆã‚’å®ˆã£ã¦ãã‚Œã¾ã™ã€‚
> **è²»ç”¨:** ç„¡æ–™

**æ‰‹é †:**
1. https://www.cloudflare.com ã‚’é–‹ã
2. å³ä¸Šã€Œ**Sign Up**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ ãƒ¡ãƒ¼ãƒ«ãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ç™»éŒ²
3. ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€ã€Œ**Add a Site**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
4. `kuchikomi-farm.com` ã¨å…¥åŠ› â†’ ã€Œ**Add Site**ã€
5. ä¸€ç•ªä¸‹ã®ã€Œ**Free**ã€ãƒ—ãƒ©ãƒ³ã‚’é¸æŠ â†’ ã€Œ**Continue**ã€
6. ã€Œ**Continue**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Œäº†ã•ã›ã‚‹
7. ç”»é¢ã«**2ã¤ã®ãƒãƒ¼ãƒ ã‚µãƒ¼ãƒãƒ¼**ãŒè¡¨ç¤ºã•ã‚Œã‚‹ï¼ˆä¾‹: `xxx.ns.cloudflare.com`ï¼‰
   â†’ ã“ã‚Œã‚’ğŸ“ãƒ¡ãƒ¢ã™ã‚‹ï¼ˆæ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ä½¿ã†ï¼‰

**Namecheapã§ãƒãƒ¼ãƒ ã‚µãƒ¼ãƒãƒ¼ã‚’å¤‰æ›´ã™ã‚‹:**
8. Namecheapã«æˆ»ã‚‹ â†’ ã€Œ**Domain List**ã€â†’ `kuchikomi-farm.com` ã®ã€Œ**Manage**ã€
9. ã€Œ**Nameservers**ã€ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ã€Œ**Custom DNS**ã€ã«å¤‰æ›´
10. Cloudflareã®ãƒãƒ¼ãƒ ã‚µãƒ¼ãƒãƒ¼ã‚’Nameserver 1ãƒ»2ã«å…¥åŠ› â†’ ä¿å­˜
11. Cloudflareã«æˆ»ã‚Šã€Œ**Done, check nameservers**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯

> âš ï¸ ãƒãƒ¼ãƒ ã‚µãƒ¼ãƒãƒ¼ã®åæ˜ ã«æœ€å¤§48æ™‚é–“ã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ï¼ˆé€šå¸¸ã¯æ•°æ™‚é–“ï¼‰

âœ… Cloudflareè¨­å®šå®Œäº†

---

### 1-4. Supabaseï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼‰
> **ä½•ã®ãŸã‚ï¼Ÿ** ä¼šå“¡æƒ…å ±ãƒ»è¨˜äº‹ãƒ»ã„ã„ã­ãªã©ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿ç®¡ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚
> ã€ŒExcelã®è¶…é«˜æ©Ÿèƒ½ç‰ˆãŒã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆä¸Šã«ã‚ã‚‹ã€ã¨ã„ã†ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚
> **è²»ç”¨:** ç„¡æ–™ï¼ˆæœˆ500MBã¾ã§ï¼‰

**æ‰‹é †:**
1. https://supabase.com ã‚’é–‹ã
2. å³ä¸Šã€Œ**Start your project**ã€â†’ã€Œ**Sign Up with GitHub**ã€ã§GitHubã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³
3. ã€Œ**New Project**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
4. ä»¥ä¸‹ã‚’è¨­å®š:
   - Name: `japan-local-media`
   - Database Password: å¼·åŠ›ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è‡ªåˆ†ã§è¨­å®šï¼ˆğŸ“å¿…ãšãƒ¡ãƒ¢ã™ã‚‹ï¼‰
   - Region: **Northeast Asia (Tokyo)** ã‚’é¸æŠ
5. ã€Œ**Create new project**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼ˆä½œæˆã«1ã€œ2åˆ†ã‹ã‹ã‚Šã¾ã™ï¼‰
6. ä½œæˆå®Œäº†å¾Œã€å·¦å´ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€Œ**Project Settings**ã€â†’ã€Œ**API**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
7. ä»¥ä¸‹ã‚’ãƒ¡ãƒ¢å¸³ã«è¨˜éŒ²:
   - **Project URL**: `https://xxxx.supabase.co` ã¨ã„ã†å½¢å¼ã®URL
   - **anon public**: `eyJ...` ã‹ã‚‰å§‹ã¾ã‚‹é•·ã„æ–‡å­—åˆ—
   - **service_role**: `eyJ...` ã‹ã‚‰å§‹ã¾ã‚‹åˆ¥ã®é•·ã„æ–‡å­—åˆ— â† âš ï¸ç‰¹ã«å³é‡ã«ç®¡ç†ï¼

> âš ï¸ **service_roleã‚­ãƒ¼ã¯çµ¶å¯¾ã«ä»–äººã«è¦‹ã›ã¦ã¯ã„ã‘ã¾ã›ã‚“ã€‚**
> ã“ã®ã‚­ãƒ¼ãŒã‚ã‚‹ã¨å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ“ä½œã§ãã¦ã—ã¾ã„ã¾ã™ã€‚

âœ… Supabaseè¨­å®šå®Œäº†

---

### 1-5. Clerkï¼ˆãƒ­ã‚°ã‚¤ãƒ³ãƒ»ä¼šå“¡ç™»éŒ²ã®ç®¡ç†ï¼‰
> **ä½•ã®ãŸã‚ï¼Ÿ** ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒ»ä¼šå“¡ç™»éŒ²ã®ä»•çµ„ã¿ã‚’æä¾›ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚
> æœ¬æ¥ä½œã‚‹ã®ã«æ•°é€±é–“ã‹ã‹ã‚‹ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã‚’ã€æ•°æ™‚é–“ã§å®Ÿè£…ã§ãã¾ã™ã€‚
> **è²»ç”¨:** ç„¡æ–™ï¼ˆæœˆ1ä¸‡äººã¾ã§ï¼‰

**æ‰‹é †:**
1. https://clerk.com ã‚’é–‹ã
2. ã€Œ**Start Building for Free**ã€â†’ GitHubã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³
3. ã€Œ**Create application**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
4. ä»¥ä¸‹ã‚’è¨­å®š:
   - Application name: `japan-local-media`
   - Sign-in options: ã€Œ**Email**ã€ã¨ã€Œ**Password**ã€ã«ãƒã‚§ãƒƒã‚¯
5. ã€Œ**Create Application**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
6. å·¦å´ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€Œ**API Keys**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
7. ä»¥ä¸‹ã‚’ãƒ¡ãƒ¢å¸³ã«è¨˜éŒ²:
   - **Publishable key**: `pk_live_...` ã‹ã‚‰å§‹ã¾ã‚‹ã‚­ãƒ¼
   - **Secret keys** â†’ ã€Œ**Show Secret Key**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ `sk_live_...` ã‚’ãƒ¡ãƒ¢

**Webhookï¼ˆè‡ªå‹•é€šçŸ¥ï¼‰ã®è¨­å®š:**
8. å·¦å´ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€Œ**Webhooks**ã€â†’ã€Œ**Add Endpoint**ã€
9. URLæ¬„ã«ã¯å¾Œã§Vercelã®URLã‚’å…¥åŠ›ã™ã‚‹ã®ã§ã€ä»Šã¯ç©ºæ¬„ã®ã¾ã¾ã«ã—ã¦æ¬¡ã®è¨­å®šã¸
   ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«æˆ»ã£ã¦ãã¦è¨­å®šã—ã¾ã™ï¼‰
10. ã€ŒSigning Secretã€ã‚’ãƒ¡ãƒ¢ã—ã¦ãŠãï¼ˆWebhookè¨­å®šå¾Œã«è¡¨ç¤ºã•ã‚Œã‚‹ï¼‰

âœ… Clerkè¨­å®šå®Œäº†

---

### 1-6. Resendï¼ˆã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ãƒ¡ãƒ¼ãƒ«ã‚’é€ã‚‹ï¼‰
> **ä½•ã®ãŸã‚ï¼Ÿ** ã€Œä¼šå“¡ç™»éŒ²ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€ã€Œæ‰¿èªã•ã‚Œã¾ã—ãŸã€ãªã©ã®
> ãƒ¡ãƒ¼ãƒ«ã‚’è‡ªå‹•ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€ã‚‹ãŸã‚ã®ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚
> Gmailã¯å¤§é‡é€ä¿¡ã«å‘ã‹ãªã„ãŸã‚ã€å°‚ç”¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ã„ã¾ã™ã€‚
> **è²»ç”¨:** ç„¡æ–™ï¼ˆæœˆ3,000é€šã¾ã§ï¼‰

**æ‰‹é †:**
1. https://resend.com ã‚’é–‹ã
2. ã€Œ**Get Started**ã€â†’ GitHubã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³
3. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰ã€å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€Œ**Domains**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
4. ã€Œ**Add Domain**ã€â†’ `kuchikomi-farm.com` ã‚’å…¥åŠ› â†’ ã€Œ**Add**ã€
5. DNSãƒ¬ã‚³ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹ â†’ ä»¥ä¸‹ã®3ç¨®é¡ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’Cloudflareã«è¿½åŠ ã™ã‚‹

**Cloudflareã«ãƒ¡ãƒ¼ãƒ«èªè¨¼ç”¨ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã™ã‚‹:**
6. Cloudflareã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’é–‹ã â†’ `kuchikomi-farm.com` ã‚’é¸æŠ
7. ã€Œ**DNS**ã€â†’ã€Œ**Add Record**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
8. Resendã«è¡¨ç¤ºã•ã‚ŒãŸå„ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’1ã¤ãšã¤è¿½åŠ :
   - Typeã€ŒTXTã€ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ â†’ Cloudflareã§Type: TXTã‚’é¸æŠã—ã¦å…¥åŠ›
   - Typeã€ŒMXã€ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ â†’ Cloudflareã§Type: MXã‚’é¸æŠã—ã¦å…¥åŠ›
   - DKIMç”¨ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ â†’ åŒæ§˜ã«è¿½åŠ 
9. Resendã«æˆ»ã‚Šã€Œ**Verify Domain**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ ç·‘è‰²ã®ã€ŒVerifiedã€ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°OK

**APIã‚­ãƒ¼ã‚’å–å¾—:**
10. å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€Œ**API Keys**ã€â†’ã€Œ**Create API Key**ã€
11. Name: `japan-local-media-prod`
12. Permission: ã€Œ**Full Access**ã€
13. ã€Œ**Create**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
14. è¡¨ç¤ºã•ã‚ŒãŸ `re_...` ã¨ã„ã†ã‚­ãƒ¼ã‚’ğŸ“ãƒ¡ãƒ¢ã™ã‚‹ï¼ˆ**ã“ã®ç”»é¢ã‚’é–‰ã˜ã‚‹ã¨äºŒåº¦ã¨è¦‹ã‚‰ã‚Œã¾ã›ã‚“**ï¼‰

âœ… Resendè¨­å®šå®Œäº†

---

### 1-7. Upstashï¼ˆé«˜é€ŸåŒ–ãƒ»ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹é˜²æ­¢ï¼‰
> **ä½•ã®ãŸã‚ï¼Ÿ** ã‚ˆãä½¿ã†ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ™‚çš„ã«é«˜é€Ÿã§èª­ã¿æ›¸ãã§ãã‚‹å ´æ‰€ã«ç½®ãã“ã¨ã§
> ã‚µãƒ¼ãƒ“ã‚¹ã®å¿œç­”é€Ÿåº¦ã‚’æ”¹å–„ã—ã¾ã™ã€‚ã¾ãŸã€Œ1åˆ†é–“ã«ä½•ç™¾å›ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã‚‹
> ä¸æ­£ãªbotã€ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã«ã‚‚ä½¿ã„ã¾ã™ã€‚
> **è²»ç”¨:** ç„¡æ–™ï¼ˆæœˆ1ä¸‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¾ã§ï¼‰

**æ‰‹é †:**
1. https://upstash.com ã‚’é–‹ã
2. ã€Œ**Start for Free**ã€â†’ GitHubã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³
3. ã€Œ**Create Database**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
4. ä»¥ä¸‹ã‚’è¨­å®š:
   - Name: `japan-local-media-cache`
   - Type: **Regional**
   - Region: **ap-northeast-1 (Tokyo)** ã‚’é¸æŠ
5. ã€Œ**Create**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
6. ä½œæˆå¾Œã®ãƒšãƒ¼ã‚¸ã§ã€Œ**REST API**ã€ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯
7. ä»¥ä¸‹ã‚’ãƒ¡ãƒ¢å¸³ã«è¨˜éŒ²:
   - **UPSTASH_REDIS_REST_URL**: `https://...upstash.io` ã®å½¢å¼
   - **UPSTASH_REDIS_REST_TOKEN**: é•·ã„è‹±æ•°å­—ã®æ–‡å­—åˆ—

âœ… Upstashè¨­å®šå®Œäº†

---

### 1-8. PostHogï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œå‹•åˆ†æï¼‰
> **ä½•ã®ãŸã‚ï¼Ÿ** ã€Œã©ã®ãƒšãƒ¼ã‚¸ã«ä½•äººæ¥ãŸã‹ã€ã€Œã©ã®ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã‹ã€ã€Œã©ã“ã§
> é›¢è„±ã—ãŸã‹ã€ã‚’å¯è¦–åŒ–ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚æ„Ÿè¦šã§ã¯ãªããƒ‡ãƒ¼ã‚¿ã§ã‚µãƒ¼ãƒ“ã‚¹ã‚’
> æ”¹å–„ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
> **è²»ç”¨:** ç„¡æ–™ï¼ˆæœˆ100ä¸‡ã‚¤ãƒ™ãƒ³ãƒˆã¾ã§ï¼‰

**æ‰‹é †:**
1. https://posthog.com ã‚’é–‹ã
2. ã€Œ**Get started for free**ã€â†’ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ç™»éŒ²
3. Organization name: `japan-local-media` ã¨å…¥åŠ›
4. ã€Œ**Create Organization**ã€
5. Project name: `production` â†’ ã€Œ**Create Project**ã€
6. ã€Œ**Web**ã€ã‚’é¸æŠ
7. å·¦ä¸‹ã®æ­¯è»Šã‚¢ã‚¤ã‚³ãƒ³ã€Œ**Settings**ã€â†’ã€Œ**Project settings**ã€
8. ã€Œ**Project API Key**ã€ï¼ˆ`phc_...`ï¼‰ã‚’ãƒ¡ãƒ¢å¸³ã«è¨˜éŒ²
9. ã€Œ**Host**ã€ã¯ `https://us.posthog.com` ã‚’ãƒ¡ãƒ¢

âœ… PostHogè¨­å®šå®Œäº†

---

### 1-10. Sentryï¼ˆã‚¨ãƒ©ãƒ¼è‡ªå‹•é€šçŸ¥ï¼‰
> **ä½•ã®ãŸã‚ï¼Ÿ** ã‚µãƒ¼ãƒ“ã‚¹ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã¨ãã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰å•ã„åˆã‚ã›ãŒ
> æ¥ã‚‹å‰ã«è‡ªå‹•ã§é€šçŸ¥ã—ã¦ãã‚Œã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå›°ã£ã¦ã„ã‚‹çŠ¶æ³ã‚’
> è‡ªåˆ†ãŒæœ€åˆã«ç™ºè¦‹ã§ãã‚‹ã€ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
> **è²»ç”¨:** ç„¡æ–™ï¼ˆæœˆ5,000ã‚¨ãƒ©ãƒ¼ã¾ã§ï¼‰

**æ‰‹é †:**
1. https://sentry.io ã‚’é–‹ã
2. ã€Œ**Try for free**ã€â†’ GitHubã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³
3. çµ„ç¹”åã‚’å…¥åŠ›ï¼ˆä¾‹: `japan-local-media`ï¼‰â†’ ã€Œ**Create Organization**ã€
4. ã€Œ**Create Project**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
5. ä¸€è¦§ã‹ã‚‰ã€Œ**Next.js**ã€ã‚’é¸æŠ
6. Alert frequency: ã€Œ**Alert me on every new issue**ã€ã‚’é¸æŠ
7. Project name: `japan-local-media` â†’ ã€Œ**Create Project**ã€
8. è¡¨ç¤ºã•ã‚ŒãŸã€Œ**DSN**ã€ï¼ˆ`https://xxx@xxx.ingest.sentry.io/xxx`ï¼‰ã‚’ãƒ¡ãƒ¢å¸³ã«è¨˜éŒ²

âœ… Sentryè¨­å®šå®Œäº†

---

### 1-11. Vercelï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«å…¬é–‹ï¼‰
> **ä½•ã®ãŸã‚ï¼Ÿ** è‡ªåˆ†ã®ãƒ‘ã‚½ã‚³ãƒ³ã§ä½œã£ãŸã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆä¸Šã«å…¬é–‹ã™ã‚‹
> ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚ã‚³ãƒ¼ãƒ‰ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã ã‘ã§ä¸–ç•Œä¸­ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹URLãŒ
> è‡ªå‹•ç™ºè¡Œã•ã‚Œã¾ã™ã€‚SSLè¨¼æ˜æ›¸ï¼ˆğŸ”’ãƒãƒ¼ã‚¯ï¼‰ã‚‚è‡ªå‹•ã§ã™ã€‚
> **è²»ç”¨:** ç„¡æ–™ï¼ˆå€‹äººãƒ»å°è¦æ¨¡åˆ©ç”¨ï¼‰

**æ‰‹é †:**
1. https://vercel.com ã‚’é–‹ã
2. ã€Œ**Sign Up**ã€â†’ã€Œ**Continue with GitHub**ã€
3. ã€Œ**Add New Project**ã€â†’ GitHubã® `japan-local-media` ãƒªãƒã‚¸ãƒˆãƒªã‚’é¸æŠ
4. ã€Œ**Import**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
5. **âš ï¸ ã¾ã ã€ŒDeployã€ã¯ã‚¯ãƒªãƒƒã‚¯ã—ãªã„** â†’ æ¬¡ã®STEP 2ã§ã‚³ãƒ¼ãƒ‰ãŒã§ãã¦ã‹ã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™

**ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ç™»éŒ²ï¼ˆå¾Œã§ã‚„ã‚‹ä½œæ¥­ã®ãŸã‚ã®ä¸‹æº–å‚™ï¼‰:**
6. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚Šã€ä½œæˆã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯
7. ã€Œ**Settings**ã€â†’ã€Œ**Domains**ã€â†’ã€Œ**Add**ã€
8. `kuchikomi-farm.com` ã¨å…¥åŠ› â†’ ã€Œ**Add**ã€

**Cloudflareã«ç¹‹ããŸã‚ã®DNSãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’è¨­å®š:**
9. VercelãŒã€ŒCNAME ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€ã¨è¡¨ç¤ºã™ã‚‹
10. Cloudflareã‚’é–‹ã â†’ `kuchikomi-farm.com` â†’ ã€Œ**DNS**ã€â†’ã€Œ**Add Record**ã€
11. Type: `CNAME`, Name: `@`, Target: `cname.vercel-dns.com` ã‚’å…¥åŠ› â†’ ã€Œ**Save**ã€

âœ… Vercelè¨­å®šå®Œäº†ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ã¯STEP 3ã§å®Ÿæ–½ï¼‰

---

## STEP 2: Claude Codeã«é–‹ç™ºä¾é ¼ã™ã‚‹

> ğŸ’¡ **ã“ã®STEPã«ã¤ã„ã¦**
> ä»¥ä¸‹ã®**ã€ŒClaude Codeã¸ã®ä¾é ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€**ã‚’ã¾ã‚‹ã”ã¨ã‚³ãƒ”ãƒ¼ã—ã¦ã€
> Claude Codeã®ãƒãƒ£ãƒƒãƒˆç”»é¢ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚
> AIãŒè‡ªå‹•ã§ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¾ã™ã€‚

---

### ğŸ“Œ Claude Codeã¸ã®ä¾é ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆã“ã“ã‹ã‚‰ã‚³ãƒ”ãƒ¼ï¼‰

---

```
# TheJapanLocalMedia â€” æ–°è¦æ§‹ç¯‰ä¾é ¼

## æ¦‚è¦
æ‹›å¾…åˆ¶ã‚¯ãƒ­ãƒ¼ã‚ºãƒ‰ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’æ–°è¦æ§‹ç¯‰ã—ã¦ãã ã•ã„ã€‚
æ—¢å­˜ã®å‚è€ƒå®Ÿè£…ãŒä»¥ä¸‹ã®ãƒ‘ã‚¹ã«ã‚ã‚Šã¾ã™ã€‚UIãƒ‡ã‚¶ã‚¤ãƒ³ãƒ»æ©Ÿèƒ½ãƒ»DBã‚¹ã‚­ãƒ¼ãƒã‚’
å¿ å®Ÿã«è¸è¥²ã—ãªãŒã‚‰ã€èªè¨¼ã‚’Clerkã«ç§»è¡Œã—ã€ãƒ¡ãƒ¼ãƒ«ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»AIæ¨è–¦ãƒ»
åˆ†æãƒ»ã‚¨ãƒ©ãƒ¼ç›£è¦–ã‚’æ–°ã‚¹ã‚¿ãƒƒã‚¯ã§å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚

å‚è€ƒã‚³ãƒ¼ãƒ‰: /Users/[ã‚ãªãŸã®Macã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å]/Desktop/closed-media-ui

ãƒ‰ãƒ¡ã‚¤ãƒ³: kuchikomi-farm.com

## ä½¿ç”¨ã‚¹ã‚¿ãƒƒã‚¯
- **ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯**: Next.js 15 (App Router) + React 19 + TypeScript strict
- **UI**: shadcn/ui + Tailwind CSS
- **èªè¨¼**: Clerkï¼ˆSupabase Authã‹ã‚‰ç§»è¡Œï¼‰
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: Supabase PostgreSQLï¼ˆService RoleçµŒç”±ã§Server Actionsã‹ã‚‰æ“ä½œï¼‰
- **ãƒ¡ãƒ¼ãƒ«**: Resend + React Email
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»ãƒ¬ãƒ¼ãƒˆåˆ¶é™**: Upstash Redis
- **ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆåˆ†æ**: PostHog
- **ã‚¨ãƒ©ãƒ¼ç›£è¦–**: Sentry
- **ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°**: Vercel
- **ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†**: GitHub

## æ‰‹é †1: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–

ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:

```bash
npx create-next-app@latest japan-local-media \
  --typescript \
  --tailwind \
  --app \
  --src-dir \
  --import-alias "@/*"

cd japan-local-media

npm install \
  @clerk/nextjs \
  @supabase/supabase-js \
  @upstash/redis \
  @upstash/ratelimit \
  resend \
  react-email \
  @react-email/components \
  posthog-js \
  posthog-node \
  @sentry/nextjs \
  zustand \
  zod \
  recharts \
  lucide-react \
  next-themes \
  date-fns \
  react-markdown \
  remark-gfm \
  svix

npm install -D @types/node

npx shadcn@latest init
# Style: Default / Base color: Zinc / CSS variables: Yes

npx shadcn@latest add button input label card badge avatar dialog sheet \
  tabs select textarea toast toaster alert separator skeleton progress switch
```

## æ‰‹é †2: ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã« `.env.local` ã‚’ä½œæˆã—ã¦ä»¥ä¸‹ã‚’è¨˜å…¥:

```env
# â”€â”€ Clerkï¼ˆèªè¨¼ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_live_ã“ã“ã«å…¥åŠ›
CLERK_SECRET_KEY=sk_live_ã“ã“ã«å…¥åŠ›
CLERK_WEBHOOK_SECRET=whsec_ã“ã“ã«å…¥åŠ›ï¼ˆWebhookè¨­å®šå¾Œã«å…¥åŠ›ï¼‰
NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up
NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/feed
NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/signup/complete

# â”€â”€ Supabaseï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
NEXT_PUBLIC_SUPABASE_URL=https://ã“ã“ã«å…¥åŠ›.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=ã“ã“ã«å…¥åŠ›
SUPABASE_SERVICE_ROLE_KEY=ã“ã“ã«å…¥åŠ›

# â”€â”€ Resendï¼ˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
RESEND_API_KEY=re_ã“ã“ã«å…¥åŠ›
RESEND_FROM_EMAIL=noreply@kuchikomi-farm.com

# â”€â”€ Upstash Redisï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
UPSTASH_REDIS_REST_URL=https://ã“ã“ã«å…¥åŠ›.upstash.io
UPSTASH_REDIS_REST_TOKEN=ã“ã“ã«å…¥åŠ›

# â”€â”€ PostHogï¼ˆåˆ†æï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
NEXT_PUBLIC_POSTHOG_KEY=phc_ã“ã“ã«å…¥åŠ›
NEXT_PUBLIC_POSTHOG_HOST=https://us.posthog.com

# â”€â”€ Sentryï¼ˆã‚¨ãƒ©ãƒ¼ç›£è¦–ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
NEXT_PUBLIC_SENTRY_DSN=https://ã“ã“ã«å…¥åŠ›@ã“ã“ã«å…¥åŠ›.ingest.sentry.io/ã“ã“ã«å…¥åŠ›

# â”€â”€ ã‚¢ãƒ—ãƒªè¨­å®š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
NEXT_PUBLIC_APP_URL=https://kuchikomi-farm.com
```

## æ‰‹é †3: Supabaseã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’è¨­å®š

Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆhttps://supabase.comï¼‰ã‚’é–‹ãã€
å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€Œ**SQL Editor**ã€â†’ã€Œ**New query**ã€ã§
ä»¥ä¸‹ã®SQLã‚’**é †ç•ªã«**å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
ã€ŒRunã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨å®Ÿè¡Œã§ãã¾ã™ã€‚

### SQL 1/4: å‹å®šç¾©ã¨å…±é€šé–¢æ•°

```sql
-- æ‹¡å¼µæ©Ÿèƒ½ã®æœ‰åŠ¹åŒ–
create extension if not exists "pgcrypto";

-- ãƒ¡ãƒ³ãƒãƒ¼ãƒ©ãƒ³ã‚¯ï¼ˆä¼šå“¡ã®ç­‰ç´šï¼‰
create type member_rank as enum ('standard', 'gold', 'platinum', 'diamond');

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½¹å‰²
create type user_role as enum ('member', 'admin');

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
create type user_status as enum ('pending', 'active', 'suspended');

-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ç¨®é¡
create type content_type as enum ('article', 'video', 'external');

-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å…¬é–‹çŠ¶æ…‹
create type content_status as enum ('draft', 'scheduled', 'published');

-- ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã®ç¨®é¡
create type interaction_type as enum ('view', 'like', 'bookmark');

-- ã‚¢ãƒ³ãƒ­ãƒƒã‚¯æ¡ä»¶ã®ç¨®é¡
create type unlock_condition_type as enum (
  'content_views_3',
  'profile_completed',
  'first_share',
  'feedback_sent'
);

-- updated_at ã‚’è‡ªå‹•æ›´æ–°ã™ã‚‹å…±é€šé–¢æ•°
create or replace function update_updated_at()
returns trigger as $$
begin
  new.updated_at = now();
  return new;
end;
$$ language plpgsql;
```

### SQL 2/4: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ»æ‹›å¾…ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼ˆClerké€£æº: profiles.id = Clerkã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼‰
create table profiles (
  id                text primary key,        -- ClerkãŒç™ºè¡Œã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
  member_id         text unique not null,    -- JK-00001 å½¢å¼ã®ä¼šå“¡ID
  display_name      text not null,
  email             text not null unique,
  phone             text,
  bio               text,
  location          text,
  company           text,
  position          text,
  avatar_url        text,
  rank              member_rank not null default 'standard',
  role              user_role not null default 'member',
  status            user_status not null default 'pending',
  screening_answer  text,
  invited_by        text references profiles(id),
  created_at        timestamptz not null default now(),
  updated_at        timestamptz not null default now()
);

-- ä¼šå“¡IDã‚’è‡ªå‹•æ¡ç•ªï¼ˆJK-00001, JK-00002, ...ï¼‰
create or replace function generate_member_id()
returns trigger as $$
begin
  new.member_id := 'JK-' || lpad(
    (select coalesce(max(substring(member_id from 4)::int), 0) + 1
     from profiles)::text,
    5, '0'
  );
  return new;
end;
$$ language plpgsql;

create trigger trg_member_id
  before insert on profiles
  for each row execute function generate_member_id();

create trigger trg_profiles_updated
  before update on profiles
  for each row execute function update_updated_at();

-- æ‹›å¾…ã‚³ãƒ¼ãƒ‰
create table invite_codes (
  id          uuid primary key default gen_random_uuid(),
  code        text unique not null,
  created_by  text not null references profiles(id),
  is_used     boolean not null default false,
  click_count int not null default 0,
  expires_at  timestamptz,
  created_at  timestamptz not null default now()
);
create index idx_invite_codes_code on invite_codes(code);

-- ç´¹ä»‹ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°
create table referrals (
  id              uuid primary key default gen_random_uuid(),
  referrer_id     text not null references profiles(id),
  referred_id     text references profiles(id),
  invite_code_id  uuid references invite_codes(id),
  clicked_at      timestamptz not null default now(),
  registered_at   timestamptz
);
create index idx_referrals_referrer on referrals(referrer_id);

-- æ‹›å¾…ã‚¹ãƒ­ãƒƒãƒˆï¼ˆå„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒã¦ã‚‹æ‹›å¾…æ æ•°ï¼‰
create table invite_slots (
  id            uuid primary key default gen_random_uuid(),
  user_id       text not null references profiles(id) on delete cascade,
  initial_slots int not null default 2,
  bonus_slots   int not null default 0,
  used_slots    int not null default 0,
  updated_at    timestamptz not null default now(),
  unique(user_id)
);

-- ã‚¢ãƒ³ãƒ­ãƒƒã‚¯æ¡ä»¶ï¼ˆãƒœãƒ¼ãƒŠã‚¹æ‹›å¾…æ ç²å¾—æ¡ä»¶ã®é€²æ—ï¼‰
create table slot_unlock_conditions (
  id            uuid primary key default gen_random_uuid(),
  user_id       text not null references profiles(id) on delete cascade,
  condition     unlock_condition_type not null,
  completed     boolean not null default false,
  completed_at  timestamptz,
  unique(user_id, condition)
);
```

### SQL 3/4: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ»å ±é…¬ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆè¨˜äº‹ãƒ»å‹•ç”»ãƒ»å¤–éƒ¨ãƒªãƒ³ã‚¯ï¼‰
create table contents (
  id               uuid primary key default gen_random_uuid(),
  type             content_type not null,
  title            text not null,
  description      text,
  body             text,
  status           content_status not null default 'draft',
  publish_date     timestamptz,
  author_id        text references profiles(id),
  author_name      text not null,
  author_bio       text,
  thumbnail_url    text,
  url              text,
  duration         text,
  views            int not null default 0,
  likes            int not null default 0,
  premium          boolean not null default false,
  required_rank    member_rank not null default 'standard',
  created_at       timestamptz not null default now(),
  updated_at       timestamptz not null default now()
);

create trigger trg_contents_updated
  before update on contents
  for each row execute function update_updated_at();

create index idx_contents_status on contents(status);
create index idx_contents_publish_date on contents(publish_date desc);

-- ã‚¿ã‚°
create table tags (
  id    uuid primary key default gen_random_uuid(),
  name  text unique not null
);

create table content_tags (
  content_id  uuid not null references contents(id) on delete cascade,
  tag_id      uuid not null references tags(id) on delete cascade,
  primary key (content_id, tag_id)
);

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ“ä½œï¼ˆã„ã„ã­ãƒ»ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ»é–²è¦§ï¼‰
create table content_interactions (
  id          uuid primary key default gen_random_uuid(),
  user_id     text not null references profiles(id) on delete cascade,
  content_id  uuid not null references contents(id) on delete cascade,
  type        interaction_type not null,
  created_at  timestamptz not null default now(),
  unique(user_id, content_id, type)
);
create index idx_interactions_content on content_interactions(content_id, type);

-- å ±é…¬ãƒ†ã‚£ã‚¢
create table rewards (
  id                  uuid primary key default gen_random_uuid(),
  title               text not null,
  description         text not null,
  required_referrals  int not null,
  icon                text not null default 'Gift',
  status              text not null default 'active'
    check (status in ('active', 'inactive')),
  created_at          timestamptz not null default now()
);

-- å ±é…¬ç”³è«‹
create table reward_claims (
  id          uuid primary key default gen_random_uuid(),
  user_id     text not null references profiles(id) on delete cascade,
  reward_id   uuid not null references rewards(id) on delete cascade,
  status      text not null default 'pending'
    check (status in ('pending', 'granted', 'rejected')),
  claimed_at  timestamptz not null default now(),
  granted_at  timestamptz,
  unique(user_id, reward_id)
);

-- ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆé€šçŸ¥
create table broadcasts (
  id          uuid primary key default gen_random_uuid(),
  title       text not null,
  body        text not null,
  target_rank text not null default 'all',
  status      text not null default 'sent'
    check (status in ('sent', 'failed', 'scheduled')),
  sent_at     timestamptz not null default now(),
  created_by  text references profiles(id)
);

-- é€šçŸ¥è¨­å®š
create table notification_preferences (
  user_id               text primary key references profiles(id) on delete cascade,
  email_new_content     boolean not null default true,
  email_newsletter      boolean not null default true,
  email_invite_update   boolean not null default true,
  push_browser          boolean not null default false,
  updated_at            timestamptz not null default now()
);

-- ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´
create table login_history (
  id            uuid primary key default gen_random_uuid(),
  user_id       text not null references profiles(id) on delete cascade,
  device        text,
  ip_address    text,
  logged_in_at  timestamptz not null default now()
);
create index idx_login_history_user on login_history(user_id, logged_in_at desc);
```

### SQL 4/4: RLSãƒãƒªã‚·ãƒ¼ã¨åˆæœŸãƒ‡ãƒ¼ã‚¿

```sql
-- å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã®Row Level Securityï¼ˆè¡Œãƒ¬ãƒ™ãƒ«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼‰ã‚’æœ‰åŠ¹åŒ–
alter table profiles enable row level security;
alter table invite_codes enable row level security;
alter table invite_slots enable row level security;
alter table slot_unlock_conditions enable row level security;
alter table referrals enable row level security;
alter table contents enable row level security;
alter table tags enable row level security;
alter table content_tags enable row level security;
alter table content_interactions enable row level security;
alter table rewards enable row level security;
alter table reward_claims enable row level security;
alter table broadcasts enable row level security;
alter table notification_preferences enable row level security;
alter table login_history enable row level security;

-- â€» å…¨ã¦ã®DBæ“ä½œã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®Service Roleã§è¡Œã†ãŸã‚
-- RLSã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®å®‰å…¨å¼ã¨ã—ã¦æœ‰åŠ¹åŒ–ã®ã¿è¡Œã†ã€‚

-- åˆæœŸå ±é…¬ãƒ‡ãƒ¼ã‚¿
insert into rewards (title, description, required_referrals, icon, status) values
  (
    'éå…¬é–‹ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆÂ¥10ä¸‡ç›¸å½“ï¼‰',
    '10åç´¹ä»‹é”æˆè€…é™å®šã®éå…¬é–‹ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©',
    10, 'FileText', 'active'
  ),
  (
    'Â¥100ä¸‡å††ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚µãƒ­ãƒ³å‚åŠ æ¨©',
    '100åç´¹ä»‹é”æˆè€…ã®ã¿ãŒå‚åŠ ã§ãã‚‹é™å®šã‚µãƒ­ãƒ³ã¸ã®æ‹›å¾…',
    100, 'Users', 'active'
  ),
  (
    'ä¸»å‚¬è€…ãƒ»ãƒˆãƒƒãƒ—äººæã¨ã®1on1',
    '1000åç´¹ä»‹é”æˆã®è¨¼ã¨ã—ã¦ã€ä¸»å‚¬è€…ã¾ãŸã¯å„ç•Œãƒˆãƒƒãƒ—äººæã¨ã®ç‰¹åˆ¥å¯¾è«‡',
    1000, 'Crown', 'active'
  );
```

## æ‰‹é †4: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

ä»¥ä¸‹ã®æ§‹æˆã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
æ—¢å­˜ã® `closed-media-ui` ã®UIãƒ‡ã‚¶ã‚¤ãƒ³ã‚’**ãã®ã¾ã¾æµç”¨**ã—ãªãŒã‚‰ã€
èªè¨¼éƒ¨åˆ†ã‚’Clerkã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚

```
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ layout.tsx              # ClerkProvider + PostHog + Sentry ã‚’è¨­å®š
â”‚   â”œâ”€â”€ middleware.ts            # Clerkèªè¨¼ã‚¬ãƒ¼ãƒ‰ï¼ˆæœªãƒ­ã‚°ã‚¤ãƒ³ã‚’ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼‰
â”‚   â”œâ”€â”€ (auth)/
â”‚   â”‚   â”œâ”€â”€ sign-in/[[...sign-in]]/page.tsx   # Clerkã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒšãƒ¼ã‚¸
â”‚   â”‚   â””â”€â”€ sign-up/[[...sign-up]]/page.tsx   # Clerkã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒšãƒ¼ã‚¸
â”‚   â”œâ”€â”€ signup/
â”‚   â”‚   â””â”€â”€ complete/page.tsx   # ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°è³ªå•ï¼ˆå…¥ä¼šç†ç”±ï¼‰
â”‚   â”œâ”€â”€ feed/page.tsx           # ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚£ãƒ¼ãƒ‰ï¼ˆå‚è€ƒ: closed-media-ui/app/feedï¼‰
â”‚   â”œâ”€â”€ article/[id]/page.tsx   # è¨˜äº‹è©³ç´°ï¼ˆå‚è€ƒ: closed-media-ui/app/articleï¼‰
â”‚   â”œâ”€â”€ mypage/page.tsx         # ãƒã‚¤ãƒšãƒ¼ã‚¸ï¼ˆå‚è€ƒ: closed-media-ui/app/mypageï¼‰
â”‚   â”œâ”€â”€ favorites/page.tsx      # ãŠæ°—ã«å…¥ã‚Š
â”‚   â”œâ”€â”€ settings/page.tsx       # è¨­å®šï¼ˆå‚è€ƒ: closed-media-ui/app/settingsï¼‰
â”‚   â”œâ”€â”€ admin/page.tsx          # ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆå‚è€ƒ: closed-media-ui/app/adminï¼‰
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ webhooks/
â”‚           â””â”€â”€ clerk/route.ts  # Clerk Webhookï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆæ™‚ã«Supabaseã«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä½œæˆï¼‰
â”œâ”€â”€ actions/
â”‚   â”œâ”€â”€ auth.ts                 # æ‹›å¾…ã‚³ãƒ¼ãƒ‰æ¤œè¨¼ãƒ»ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ“ä½œ
â”‚   â”œâ”€â”€ content.ts              # ã‚³ãƒ³ãƒ†ãƒ³ãƒ„CRUD
â”‚   â”œâ”€â”€ profile.ts              # ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°ãƒ»æ‹›å¾…ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
â”‚   â”œâ”€â”€ interactions.ts         # ã„ã„ã­ãƒ»ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ»é–²è¦§
â”‚   â””â”€â”€ admin.ts                # ç®¡ç†è€…æ“ä½œï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªç­‰ï¼‰
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ supabase.ts             # Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆadminã‚­ãƒ¼ä½¿ç”¨ï¼‰
â”‚   â”œâ”€â”€ redis.ts                # Upstash Redisã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ + ãƒ¬ãƒ¼ãƒˆåˆ¶é™
â”‚   â”œâ”€â”€ posthog.ts              # PostHogåˆ†æã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ email/
â”‚   â”‚   â”œâ”€â”€ index.ts            # Resendé€ä¿¡ãƒ©ãƒƒãƒ‘ãƒ¼
â”‚   â”‚   â””â”€â”€ templates/
â”‚   â”‚       â”œâ”€â”€ welcome.tsx     # ç™»éŒ²ã‚ã‚ŠãŒã¨ã†ãƒ¡ãƒ¼ãƒ«ï¼ˆReact Emailï¼‰
â”‚   â”‚       â”œâ”€â”€ approval.tsx    # æ‰¿èªå®Œäº†ãƒ¡ãƒ¼ãƒ«
â”‚   â”‚       â””â”€â”€ invite.tsx      # æ‹›å¾…ãƒ¡ãƒ¼ãƒ«
â”‚   â””â”€â”€ types.ts                # å‹å®šç¾©ï¼ˆclosed-media-ui/lib/types.ts ã‚’æµç”¨ï¼‰
â””â”€â”€ components/
    â”œâ”€â”€ ui/                     # shadcn/uiã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰
    â”œâ”€â”€ admin/                  # ç®¡ç†ç”»é¢ï¼ˆclosed-media-ui/components/admin/ ã‚’æµç”¨ï¼‰
    â”œâ”€â”€ content/                # ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    â””â”€â”€ layout/                 # ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
```

## æ‰‹é †5: middleware.tsï¼ˆèªè¨¼ã‚¬ãƒ¼ãƒ‰ï¼‰

```typescript
// src/middleware.ts
import { clerkMiddleware, createRouteMatcher } from '@clerk/nextjs/server'

// èªè¨¼ä¸è¦ã®å…¬é–‹ãƒšãƒ¼ã‚¸
const isPublicRoute = createRouteMatcher([
  '/sign-in(.*)',
  '/sign-up(.*)',
  '/api/webhooks/(.*)',
])

export default clerkMiddleware(async (auth, req) => {
  if (!isPublicRoute(req)) {
    await auth.protect()
  }
})

export const config = {
  matcher: ['/((?!.+\\.[\\w]+$|_next).*)', '/', '/(api|trpc)(.*)'],
}
```

## æ‰‹é †6: lib/supabase.tsï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰

```typescript
// src/lib/supabase.ts
import { createClient } from '@supabase/supabase-js'

// ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å°‚ç”¨ï¼ˆService Role = ç®¡ç†è€…æ¨©é™ï¼‰
// âš ï¸ ã“ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯Server Actionså†…ã§ã®ã¿ä½¿ç”¨ã™ã‚‹ã“ã¨
export const supabaseAdmin = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
)
```

## æ‰‹é †7: lib/redis.tsï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼‰

```typescript
// src/lib/redis.ts
import { Redis } from '@upstash/redis'
import { Ratelimit } from '@upstash/ratelimit'

export const redis = new Redis({
  url: process.env.UPSTASH_REDIS_REST_URL!,
  token: process.env.UPSTASH_REDIS_REST_TOKEN!,
})

// æ‹›å¾…ã‚³ãƒ¼ãƒ‰æ¤œè¨¼: åŒã˜IPã‹ã‚‰1åˆ†é–“ã«10å›ã¾ã§
export const inviteCodeRatelimit = new Ratelimit({
  redis,
  limiter: Ratelimit.slidingWindow(10, '1 m'),
  analytics: true,
  prefix: 'invite_code',
})

// ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ: åŒã˜IPã‹ã‚‰1åˆ†é–“ã«5å›ã¾ã§
export const loginRatelimit = new Ratelimit({
  redis,
  limiter: Ratelimit.slidingWindow(5, '1 m'),
  analytics: true,
  prefix: 'login',
})
```

## æ‰‹é †8: api/webhooks/clerk/route.tsï¼ˆClerk Webhookï¼‰

Clerkã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç™»éŒ²ã•ã‚ŒãŸã¨ãã€è‡ªå‹•çš„ã«Supabaseã«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹å‡¦ç†:

```typescript
// src/app/api/webhooks/clerk/route.ts
import { Webhook } from 'svix'
import { headers } from 'next/headers'
import { WebhookEvent } from '@clerk/nextjs/server'
import { supabaseAdmin } from '@/lib/supabase'
import { sendWelcomeEmail } from '@/lib/email'

export async function POST(req: Request) {
  const WEBHOOK_SECRET = process.env.CLERK_WEBHOOK_SECRET!
  const headerPayload = headers()
  const body = await req.text()

  // Webhookã®ç½²åã‚’æ¤œè¨¼ï¼ˆãªã‚Šã™ã¾ã—å¯¾ç­–ï¼‰
  const wh = new Webhook(WEBHOOK_SECRET)
  let evt: WebhookEvent
  try {
    evt = wh.verify(body, {
      'svix-id': headerPayload.get('svix-id')!,
      'svix-timestamp': headerPayload.get('svix-timestamp')!,
      'svix-signature': headerPayload.get('svix-signature')!,
    }) as WebhookEvent
  } catch {
    return new Response('Invalid webhook signature', { status: 400 })
  }

  // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ™‚ã®å‡¦ç†
  if (evt.type === 'user.created') {
    const {
      id,
      email_addresses,
      first_name,
      last_name,
      image_url,
      unsafe_metadata,
    } = evt.data

    const email = email_addresses[0]?.email_address!
    const displayName =
      [first_name, last_name].filter(Boolean).join(' ') ||
      email.split('@')[0] ||
      'ãƒ¦ãƒ¼ã‚¶ãƒ¼'

    // æ‹›å¾…ã‚³ãƒ¼ãƒ‰ï¼ˆã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰å—ã‘å–ã‚‹ï¼‰
    const inviteCode = (unsafe_metadata as Record<string, unknown>)
      ?.invite_code as string | undefined

    // æ‹›å¾…è€…ã‚’ç‰¹å®š
    let invitedBy: string | null = null
    let inviteCodeId: string | null = null

    if (inviteCode) {
      const { data: codeData } = await supabaseAdmin
        .from('invite_codes')
        .select('id, created_by')
        .eq('code', inviteCode)
        .single()

      if (codeData) {
        invitedBy = codeData.created_by
        inviteCodeId = codeData.id
      }
    }

    // Supabaseã«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä½œæˆ
    const { error } = await supabaseAdmin.from('profiles').insert({
      id,
      display_name: displayName,
      email,
      avatar_url: image_url,
      invited_by: invitedBy,
      status: 'pending',   // ç®¡ç†è€…ã®æ‰¿èªå¾…ã¡
      role: 'member',
      rank: 'standard',
    })

    if (error) {
      console.error('Profile creation failed:', error)
      return new Response('Profile creation failed', { status: 500 })
    }

    // æ‹›å¾…ã‚¹ãƒ­ãƒƒãƒˆãƒ»ã‚¢ãƒ³ãƒ­ãƒƒã‚¯æ¡ä»¶ãƒ»é€šçŸ¥è¨­å®šã‚’åˆæœŸåŒ–
    await Promise.all([
      supabaseAdmin
        .from('invite_slots')
        .insert({ user_id: id }),

      supabaseAdmin
        .from('slot_unlock_conditions')
        .insert([
          { user_id: id, condition: 'content_views_3' },
          { user_id: id, condition: 'profile_completed' },
          { user_id: id, condition: 'first_share' },
          { user_id: id, condition: 'feedback_sent' },
        ]),

      supabaseAdmin
        .from('notification_preferences')
        .insert({ user_id: id }),
    ])

    // ç´¹ä»‹ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°
    if (invitedBy && inviteCodeId) {
      await supabaseAdmin.from('referrals').insert({
        referrer_id: invitedBy,
        referred_id: id,
        invite_code_id: inviteCodeId,
        registered_at: new Date().toISOString(),
      })
    }

    // ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒ¼ãƒ«é€ä¿¡
    await sendWelcomeEmail({ email, displayName })
  }

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤æ™‚ã®å‡¦ç†
  if (evt.type === 'user.deleted') {
    if (evt.data.id) {
      await supabaseAdmin
        .from('profiles')
        .delete()
        .eq('id', evt.data.id)
    }
  }

  return new Response('OK', { status: 200 })
}
```

## æ‰‹é †9: lib/email/templates/welcome.tsxï¼ˆReact Emailï¼‰

```typescript
// src/lib/email/templates/welcome.tsx
import {
  Html, Body, Container, Text, Heading, Hr
} from '@react-email/components'

interface WelcomeEmailProps {
  displayName: string
}

export function WelcomeEmail({ displayName }: WelcomeEmailProps) {
  return (
    <Html lang="ja">
      <Body style={{
        fontFamily: '"Noto Sans JP", sans-serif',
        backgroundColor: '#f8f9fa',
        margin: 0,
        padding: 0,
      }}>
        <Container style={{
          maxWidth: '600px',
          margin: '40px auto',
          backgroundColor: '#ffffff',
          borderRadius: '8px',
          padding: '40px',
        }}>
          <Heading style={{ color: '#1B3022', marginTop: 0 }}>
            TheJapanLocalMediaã¸ã‚ˆã†ã“ã
          </Heading>
          <Text>
            {displayName}ã•ã‚“ã€ã”ç™»éŒ²ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚
          </Text>
          <Text>
            ç¾åœ¨ã€é‹å–¶ãƒãƒ¼ãƒ ãŒå…¥ä¼šå¯©æŸ»ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚
            å¯©æŸ»å®Œäº†å¾Œã€ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã”é€£çµ¡ã„ãŸã—ã¾ã™ã€‚
            é€šå¸¸1ã€œ3å–¶æ¥­æ—¥ä»¥å†…ã«ãŠè¿”äº‹ã„ãŸã—ã¾ã™ã€‚
          </Text>
          <Hr style={{ borderColor: '#D4AF37' }} />
          <Text style={{ color: '#666', fontSize: '14px' }}>
            TheJapanLocalMedia é‹å–¶ãƒãƒ¼ãƒ 
          </Text>
        </Container>
      </Body>
    </Html>
  )
}
```

## æ‰‹é †10: lib/email/templates/approval.tsxï¼ˆæ‰¿èªå®Œäº†ãƒ¡ãƒ¼ãƒ«ï¼‰

```typescript
// src/lib/email/templates/approval.tsx
import {
  Html, Body, Container, Text, Heading, Button, Hr
} from '@react-email/components'

interface ApprovalEmailProps {
  displayName: string
}

export function ApprovalEmail({ displayName }: ApprovalEmailProps) {
  return (
    <Html lang="ja">
      <Body style={{
        fontFamily: '"Noto Sans JP", sans-serif',
        backgroundColor: '#f8f9fa',
        margin: 0,
        padding: 0,
      }}>
        <Container style={{
          maxWidth: '600px',
          margin: '40px auto',
          backgroundColor: '#ffffff',
          borderRadius: '8px',
          padding: '40px',
        }}>
          <Heading style={{ color: '#1B3022', marginTop: 0 }}>
            å…¥ä¼šãŒæ‰¿èªã•ã‚Œã¾ã—ãŸ ğŸ‰
          </Heading>
          <Text>
            {displayName}ã•ã‚“ã€å…¥ä¼šå¯©æŸ»ãŒå®Œäº†ã—ã¾ã—ãŸã€‚
            TheJapanLocalMediaã¸ã‚ˆã†ã“ãï¼
          </Text>
          <Button
            href="https://kuchikomi-farm.com/feed"
            style={{
              backgroundColor: '#1B3022',
              color: '#D4AF37',
              padding: '12px 24px',
              borderRadius: '6px',
              textDecoration: 'none',
              display: 'inline-block',
              fontWeight: 'bold',
            }}
          >
            ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¦‹ã‚‹ â†’
          </Button>
          <Hr style={{ borderColor: '#D4AF37', marginTop: '32px' }} />
          <Text style={{ color: '#666', fontSize: '14px' }}>
            TheJapanLocalMedia é‹å–¶ãƒãƒ¼ãƒ 
          </Text>
        </Container>
      </Body>
    </Html>
  )
}
```

## æ‰‹é †11: lib/email/index.tsï¼ˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ©ãƒƒãƒ‘ãƒ¼ï¼‰

```typescript
// src/lib/email/index.ts
import { Resend } from 'resend'
import { render } from '@react-email/components'
import { WelcomeEmail } from './templates/welcome'
import { ApprovalEmail } from './templates/approval'

const resend = new Resend(process.env.RESEND_API_KEY!)
const FROM = process.env.RESEND_FROM_EMAIL!

export async function sendWelcomeEmail({
  email,
  displayName,
}: {
  email: string
  displayName: string
}) {
  await resend.emails.send({
    from: FROM,
    to: email,
    subject: 'ã€TheJapanLocalMediaã€‘ã”ç™»éŒ²ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™',
    html: render(WelcomeEmail({ displayName })),
  })
}

export async function sendApprovalEmail({
  email,
  displayName,
}: {
  email: string
  displayName: string
}) {
  await resend.emails.send({
    from: FROM,
    to: email,
    subject: 'ã€TheJapanLocalMediaã€‘å…¥ä¼šãŒæ‰¿èªã•ã‚Œã¾ã—ãŸ',
    html: render(ApprovalEmail({ displayName })),
  })
}
```

## æ‰‹é †12: app/layout.tsxï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰

```typescript
// src/app/layout.tsx
import { ClerkProvider } from '@clerk/nextjs'
import { Noto_Sans_JP, Noto_Serif_JP } from 'next/font/google'
import { PostHogProvider } from '@/components/posthog-provider'
import './globals.css'

const notoSansJP = Noto_Sans_JP({
  subsets: ['latin'],
  variable: '--font-noto-sans',
})

const notoSerifJP = Noto_Serif_JP({
  subsets: ['latin'],
  weight: ['400', '700'],
  variable: '--font-noto-serif',
})

export const metadata = {
  title: 'TheJapanLocalMedia',
  description: 'åœ°åŸŸå‰µç”Ÿãƒ»è¦³å…‰ã®æœ€å‰ç·šã‚’å±Šã‘ã‚‹æ‹›å¾…åˆ¶ãƒ¡ãƒ‡ã‚£ã‚¢',
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <ClerkProvider>
      <html lang="ja" className={`${notoSansJP.variable} ${notoSerifJP.variable}`}>
        <body>
          <PostHogProvider>
            {children}
          </PostHogProvider>
        </body>
      </html>
    </ClerkProvider>
  )
}
```

## æ‰‹é †14: components/posthog-provider.tsxï¼ˆåˆ†æè¨­å®šï¼‰

```typescript
// src/components/posthog-provider.tsx
'use client'
import posthog from 'posthog-js'
import { PostHogProvider as PHProvider } from 'posthog-js/react'
import { useEffect } from 'react'

export function PostHogProvider({ children }: { children: React.ReactNode }) {
  useEffect(() => {
    posthog.init(process.env.NEXT_PUBLIC_POSTHOG_KEY!, {
      api_host: process.env.NEXT_PUBLIC_POSTHOG_HOST,
      capture_pageview: true,
      capture_pageleave: true,
    })
  }, [])

  return <PHProvider client={posthog}>{children}</PHProvider>
}
```

## æ‰‹é †15: Sentryã®è¨­å®š

```bash
npx @sentry/wizard@latest -i nextjs
```

ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ãŒèµ·å‹•ã—ãŸã‚‰:
- ã€ŒDo you want to log in to Sentry?ã€â†’ Y
- ãƒ–ãƒ©ã‚¦ã‚¶ã§æ‰¿èª
- ã€ŒWhich project?ã€â†’ `japan-local-media` ã‚’é¸æŠ
- ã€ŒDo you want to add code examples?ã€â†’ Y

è‡ªå‹•ã§ `sentry.client.config.ts`ãƒ»`sentry.server.config.ts` ãŒä½œæˆã•ã‚Œã¾ã™ã€‚

## æ‰‹é †16: actions/auth.tsï¼ˆæ‹›å¾…ã‚³ãƒ¼ãƒ‰æ¤œè¨¼ï¼‰

```typescript
// src/actions/auth.ts
'use server'
import { supabaseAdmin } from '@/lib/supabase'
import { inviteCodeRatelimit } from '@/lib/redis'
import { headers } from 'next/headers'

// æ‹›å¾…ã‚³ãƒ¼ãƒ‰ã‚’æ¤œè¨¼ã—ã¦ã‚³ãƒ¼ãƒ‰æƒ…å ±ã‚’è¿”ã™
export async function verifyInviteCode(code: string) {
  // IPã‚¢ãƒ‰ãƒ¬ã‚¹ã§ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆ1åˆ†é–“ã«10å›ã¾ã§ï¼‰
  const ip = headers().get('x-forwarded-for') ?? 'unknown'
  const { success } = await inviteCodeRatelimit.limit(ip)

  if (!success) {
    return { error: 'è©¦è¡Œå›æ•°ãŒä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰ãŠè©¦ã—ãã ã•ã„ã€‚' }
  }

  if (!code || code.length < 6) {
    return { error: 'æ‹›å¾…ã‚³ãƒ¼ãƒ‰ãŒçŸ­ã™ãã¾ã™ã€‚' }
  }

  const { data, error } = await supabaseAdmin
    .from('invite_codes')
    .select('id, code, created_by, profiles!created_by(display_name)')
    .eq('code', code.toLowerCase())
    .single()

  if (error || !data) {
    return { error: 'æ‹›å¾…ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚' }
  }

  // ã‚¯ãƒªãƒƒã‚¯æ•°ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
  await supabaseAdmin
    .from('invite_codes')
    .update({ click_count: supabaseAdmin.rpc('increment', { x: 1 }) })
    .eq('id', data.id)

  const referrerName = (data.profiles as { display_name: string })?.display_name

  return {
    success: true,
    referrerName,
    codeId: data.id,
  }
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
export async function getUserStatus(userId: string) {
  const { data } = await supabaseAdmin
    .from('profiles')
    .select('status, role, rank')
    .eq('id', userId)
    .single()

  return data
}
```

## æ‰‹é †17: actions/admin.tsï¼ˆç®¡ç†è€…æ“ä½œ + æ‰¿èªãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼‰

```typescript
// src/actions/admin.ts
'use server'
import { auth } from '@clerk/nextjs/server'
import { supabaseAdmin } from '@/lib/supabase'
import { sendApprovalEmail } from '@/lib/email'
import { revalidatePath } from 'next/cache'

// ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
async function requireAdmin() {
  const { userId } = auth()
  if (!userId) throw new Error('Unauthorized')

  const { data } = await supabaseAdmin
    .from('profiles')
    .select('role')
    .eq('id', userId)
    .single()

  if (data?.role !== 'admin') throw new Error('Admin required')
  return userId
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ‰¿èªã™ã‚‹ï¼ˆpending â†’ activeï¼‰
export async function approveUser(targetUserId: string) {
  await requireAdmin()

  const { data: profile } = await supabaseAdmin
    .from('profiles')
    .select('email, display_name')
    .eq('id', targetUserId)
    .single()

  await supabaseAdmin
    .from('profiles')
    .update({ status: 'active' })
    .eq('id', targetUserId)

  // æ‰¿èªå®Œäº†ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡
  if (profile) {
    await sendApprovalEmail({
      email: profile.email,
      displayName: profile.display_name,
    })
  }

  revalidatePath('/admin')
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åœæ­¢ã™ã‚‹
export async function suspendUser(targetUserId: string) {
  await requireAdmin()
  await supabaseAdmin
    .from('profiles')
    .update({ status: 'suspended' })
    .eq('id', targetUserId)
  revalidatePath('/admin')
}

// ä¼šå“¡ãƒ©ãƒ³ã‚¯ã‚’å¤‰æ›´ã™ã‚‹ï¼ˆæ”¯æ‰•ã„ç¢ºèªå¾Œã«ç®¡ç†è€…ãŒæ‰‹å‹•ã§å¤‰æ›´ï¼‰
export async function updateUserRank(
  targetUserId: string,
  rank: 'standard' | 'gold' | 'platinum' | 'diamond'
) {
  await requireAdmin()
  await supabaseAdmin
    .from('profiles')
    .update({ rank })
    .eq('id', targetUserId)
  revalidatePath('/admin')
}
```

## æ‰‹é †18: ãƒšãƒ¼ã‚¸å®Ÿè£…ï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ã‚’æµç”¨ï¼‰

ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã¯ `closed-media-ui` ã®å¯¾å¿œãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚è€ƒã«å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚
**èªè¨¼éƒ¨åˆ†ï¼ˆuseUserStore / Supabase Authé–¢é€£ï¼‰ã‚’Clerkã®hooksã«ç½®ãæ›ãˆã‚‹ã“ã¨ãŒä¸»ãªå¤‰æ›´ç‚¹ã§ã™ã€‚**

| æ–°ãƒ•ã‚¡ã‚¤ãƒ« | å‚è€ƒãƒ•ã‚¡ã‚¤ãƒ« | ä¸»ãªå¤‰æ›´ç‚¹ |
|-----------|------------|----------|
| `app/(auth)/sign-in/page.tsx` | `app/page.tsx` | `<SignIn />` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ç½®æ› |
| `app/signup/complete/page.tsx` | `app/signup/complete/page.tsx` | `useUser()` ã§èªè¨¼æƒ…å ±å–å¾— |
| `app/feed/page.tsx` | `app/feed/page.tsx` | `useAuth()` â†’ `useUser()` |
| `app/article/[id]/page.tsx` | `app/article/[id]/page.tsx` | Clerk hooksä½¿ç”¨ |
| `app/mypage/page.tsx` | `app/mypage/page.tsx` | Clerk hooksä½¿ç”¨ |
| `app/settings/page.tsx` | `app/settings/page.tsx` | Clerk hooksä½¿ç”¨ |
| `app/admin/page.tsx` | `app/admin/page.tsx` | Clerk hooksä½¿ç”¨ |
| `app/favorites/page.tsx` | `app/favorites/page.tsx` | Clerk hooksä½¿ç”¨ |

**Clerk hooksã®ä½¿ã„æ–¹ï¼ˆå‚è€ƒï¼‰:**
```typescript
import { useUser, useAuth } from '@clerk/nextjs'

// ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
const { user, isLoaded } = useUser()

// Server Actionsã§ userId ã‚’å–å¾—
import { auth } from '@clerk/nextjs/server'
const { userId } = auth()
```

## æ‰‹é †19: ã‚«ãƒ©ãƒ¼ã‚¹ã‚­ãƒ¼ãƒ ã¨ãƒ•ã‚©ãƒ³ãƒˆï¼ˆglobals.cssï¼‰

```css
/* src/app/globals.css ã«è¿½åŠ  */
:root {
  --color-dark-green: #1B3022;
  --color-gold: #D4AF37;
  --color-light: #F8F9FA;
  --font-sans: var(--font-noto-sans), sans-serif;
  --font-serif: var(--font-noto-serif), serif;
}
```

## æ‰‹é †20: vercel.json ã®ä½œæˆ

```json
{
  "framework": "nextjs",
  "regions": ["nrt1"],
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        {
          "key": "X-Content-Type-Options",
          "value": "nosniff"
        },
        {
          "key": "X-Frame-Options",
          "value": "DENY"
        }
      ]
    }
  ]
}
```

## æœ€çµ‚ç¢ºèªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

å®Ÿè£…å®Œäº†å¾Œã€ä»¥ä¸‹ã‚’ä¸Šã‹ã‚‰é †ç•ªã«ç¢ºèªã—ã¦ãã ã•ã„:

**èªè¨¼ãƒ•ãƒ­ãƒ¼:**
- [ ] `/sign-in` ã§Clerkã®ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] `/sign-up` ã§æ‹›å¾…ã‚³ãƒ¼ãƒ‰å…¥åŠ› â†’ Clerkã®ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ç™»éŒ²å¾Œã€WebhookçµŒç”±ã§Supabaseã« profiles ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒä½œæˆã•ã‚Œã‚‹
- [ ] ç™»éŒ²è€…ã«ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒ¼ãƒ«ï¼ˆResendï¼‰ãŒå±Šã
- [ ] `/admin` ã§æ‰¿èªãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ status ãŒ `active` ã«ãªã‚‹
- [ ] æ‰¿èªå¾Œã€æ‰¿èªå®Œäº†ãƒ¡ãƒ¼ãƒ«ãŒå±Šã
- [ ] æœªæ‰¿èªï¼ˆpendingï¼‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ•ã‚£ãƒ¼ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„

**ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ãƒ­ãƒ¼:**
- [ ] `/feed` ã§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ã„ã„ã­ãƒ»ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãŒå‹•ä½œã™ã‚‹
- [ ] `/article/[id]` ã§è¨˜äº‹è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ç®¡ç†è€…ãŒã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä½œæˆãƒ»ç·¨é›†ãƒ»å‰Šé™¤ã§ãã‚‹

**ãã®ä»–:**
- [ ] `/mypage` ã§æ‹›å¾…ãƒªãƒ³ã‚¯ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] PostHogã«ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼ãŒè¨˜éŒ²ã•ã‚Œã‚‹
- [ ] Sentryã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ï¼ˆãƒ†ã‚¹ãƒˆç”¨ã‚¨ãƒ©ãƒ¼ã§ç¢ºèªï¼‰
- [ ] `kuchikomi-farm.com` ã§HTTPSæ¥ç¶šã§ãã‚‹

## å®Ÿè£…æ™‚ã®é‡è¦æ³¨æ„äº‹é …

1. **èªè¨¼ã¯Clerkã®ã¿**: Supabase Authã¯ä¸€åˆ‡ä½¿ã‚ãªã„ã€‚
   å…¨ã¦ã®èªè¨¼åˆ¤å®šã¯ `auth()` ã¾ãŸã¯ `useUser()` ã§è¡Œã†ã€‚

2. **DBæ“ä½œã¯Service RoleçµŒç”±ã®ã¿**: Server Actionså†…ã§
   `supabaseAdmin`ï¼ˆservice_roleã‚­ãƒ¼ï¼‰ã‚’ä½¿ã„ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã«ã¯
   service_roleã‚­ãƒ¼ã‚’æ¸¡ã•ãªã„ã€‚

3. **ä¼šå“¡ãƒ©ãƒ³ã‚¯ã®å¤‰æ›´ã¯æ‰‹å‹•**: Stripeã¯ä½¿ç”¨ã—ãªã„ã€‚
   ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ `updateUserRank()` ã‚’å‘¼ã¶ã€‚
   Gold/Platinum/Diamondã¸ã®ãƒ©ãƒ³ã‚¯ã‚¢ãƒƒãƒ—ã¯ç®¡ç†è€…ãŒæ‰‹å‹•ã§è¡Œã†ã€‚

4. **æ‹›å¾…ã‚³ãƒ¼ãƒ‰ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™**: `inviteCodeRatelimit` ã‚’å¿…ãšä½¿ã†ã€‚
   ä½¿ã‚ãªã„ã¨botã«ã‚ˆã‚‹ç·å½“ãŸã‚Šæ”»æ’ƒã‚’å—ã‘ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚

5. **SSRã¨CSRã®åˆ‡ã‚Šæ›¿ãˆ**: å…¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ mounted ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ã†:
   ```typescript
   const [mounted, setMounted] = useState(false)
   useEffect(() => setMounted(true), [])
   if (!mounted) return null
   ```

7. **ç®¡ç†è€…ã®è¨­å®š**: æœ€åˆã®ç®¡ç†è€…ã¯Supabase SQL Editorã§æ‰‹å‹•è¨­å®š:
   ```sql
   -- Clerkãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§è‡ªåˆ†ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ç¢ºèªã—ã¦ã‹ã‚‰å®Ÿè¡Œ
   update profiles set role = 'admin', status = 'active'
   where email = 'ã‚ãªãŸã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹@example.com';
   ```

## å‚è€ƒã«ã™ã¹ãæ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®ãƒ‘ã‚¹

- å…¨ãƒšãƒ¼ã‚¸ã®UIãƒ‡ã‚¶ã‚¤ãƒ³: `closed-media-ui/app/`
- ç®¡ç†ç”»é¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: `closed-media-ui/components/admin/`
- å‹å®šç¾©: `closed-media-ui/lib/types.ts`ï¼ˆãã®ã¾ã¾æµç”¨å¯ï¼‰
- Server Actionsãƒ‘ã‚¿ãƒ¼ãƒ³: `closed-media-ui/app/actions/`
- DBã‚¹ã‚­ãƒ¼ãƒï¼ˆå‚è€ƒï¼‰: `closed-media-ui/supabase/migrations/`
```

---

## STEP 3: Vercelã§ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»å…¬é–‹ã™ã‚‹

> STEP 2ã®Claude Codeã«ã‚ˆã‚‹é–‹ç™ºãŒå®Œäº†ã—ãŸã‚‰å®Ÿæ–½ã—ã¾ã™ã€‚

### 3-1. Vercelã«ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã™ã‚‹

1. Vercelãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆhttps://vercel.comï¼‰ã‚’é–‹ã
2. ä½œæˆã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯
3. ã€Œ**Settings**ã€â†’ã€Œ**Environment Variables**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
4. STEP 1ã®ğŸ“ãƒ¡ãƒ¢å¸³ã‚’è¦‹ãªãŒã‚‰ã€`.env.local` ã®å…¨å¤‰æ•°ã‚’å…¥åŠ›ã™ã‚‹
   - ã€ŒKeyã€æ¬„ã«å¤‰æ•°åï¼ˆä¾‹: `NEXT_PUBLIC_SUPABASE_URL`ï¼‰
   - ã€ŒValueã€æ¬„ã«å€¤
   - ã€Œ**Add**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
   - ã“ã‚Œã‚’ã™ã¹ã¦ã®å¤‰æ•°ã«ç¹°ã‚Šè¿”ã™

### 3-2. GitHubã«ã‚³ãƒ¼ãƒ‰ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹

Claude CodeãŒä½œæ¥­ã—ãŸãƒ•ã‚©ãƒ«ãƒ€ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œ:
```bash
git add .
git commit -m "åˆå›ãƒ‡ãƒ—ãƒ­ã‚¤"
git push origin main
```

GitHubã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹ã¨ã€VercelãŒè‡ªå‹•ã§ãƒ“ãƒ«ãƒ‰ï¼†å…¬é–‹ã—ã¾ã™ï¼ˆ3ã€œ5åˆ†ï¼‰ã€‚

### 3-3. Clerk Webhookã®URLã‚’è¨­å®šã™ã‚‹

1. Vercelãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§å…¬é–‹URLã‚’ç¢ºèªï¼ˆä¾‹: `https://kuchikomi-farm.com`ï¼‰
2. Clerkãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ ã€Œ**Webhooks**ã€â†’ ã€Œ**Add Endpoint**ã€
3. URL: `https://kuchikomi-farm.com/api/webhooks/clerk`
4. Events:
   - â˜‘ï¸ `user.created`
   - â˜‘ï¸ `user.updated`
   - â˜‘ï¸ `user.deleted`
5. ã€Œ**Create**ã€â†’ã€Œ**Signing Secret**ã€ã‚’ã‚³ãƒ”ãƒ¼
6. Vercelã®ç’°å¢ƒå¤‰æ•° `CLERK_WEBHOOK_SECRET` ã«è¨­å®š
7. Vercel â†’ ã€Œ**Deployments**ã€â†’ã€Œ**Redeploy**ã€

### 3-4. ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è¨­å®šã™ã‚‹

1. `https://kuchikomi-farm.com/sign-up` ã«ã‚¢ã‚¯ã‚»ã‚¹
2. è‡ªåˆ†ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ä¼šå“¡ç™»éŒ²
3. Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ ã€Œ**SQL Editor**ã€ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œ:
```sql
update profiles
set role = 'admin', status = 'active'
where email = 'ã‚ãªãŸã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹@example.com';
```

4. `https://kuchikomi-farm.com/admin` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ç®¡ç†ç”»é¢ãŒé–‹ã‘ã°OK

### 3-5. å‹•ä½œç¢ºèªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] `https://kuchikomi-farm.com` ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ— â†’ ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒ¼ãƒ«ãŒå±Šã
- [ ] ç®¡ç†ç”»é¢ã§æ‰¿èª â†’ æ‰¿èªå®Œäº†ãƒ¡ãƒ¼ãƒ«ãŒå±Šã
- [ ] ãƒ•ã‚£ãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ã§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ç®¡ç†ç”»é¢ã§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¿½åŠ ã§ãã‚‹

âœ… **å…¬é–‹å®Œäº†ï¼**

---

## ğŸ’° æœˆé–“ã‚³ã‚¹ãƒˆè©¦ç®—

| ã‚µãƒ¼ãƒ“ã‚¹ | æœˆé¡ | å‚™è€ƒ |
|---------|------|------|
| **Claude** | Â¥3,000 | AIé–‹ç™ºè£œåŠ©ï¼ˆå”¯ä¸€ã®å›ºå®šè²»ï¼‰|
| **Namecheap** | Â¥150 | ãƒ‰ãƒ¡ã‚¤ãƒ³å¹´æ‰•ã„ï¼ˆÂ¥1,800Ã·12ãƒ¶æœˆï¼‰|
| **Supabase** | Â¥0 | ç„¡æ–™ï¼ˆæœˆ500MBãƒ»500MBä»¥ä¸Šã¯Pro Â¥3,400/æœˆï¼‰|
| **Clerk** | Â¥0 | ç„¡æ–™ï¼ˆæœˆ1ä¸‡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ã§ï¼‰|
| **Vercel** | Â¥0 | ç„¡æ–™ï¼ˆå€‹äººåˆ©ç”¨ï¼‰|
| **Cloudflare** | Â¥0 | ç„¡æ–™ |
| **Resend** | Â¥0 | ç„¡æ–™ï¼ˆæœˆ3,000é€šã¾ã§ï¼‰|
| **Upstash** | Â¥0 | ç„¡æ–™ï¼ˆæœˆ1ä¸‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¾ã§ï¼‰|
| **PostHog** | Â¥0 | ç„¡æ–™ï¼ˆæœˆ100ä¸‡ã‚¤ãƒ™ãƒ³ãƒˆã¾ã§ï¼‰|
| **Sentry** | Â¥0 | ç„¡æ–™ï¼ˆæœˆ5,000ã‚¨ãƒ©ãƒ¼ã¾ã§ï¼‰|
| ğŸ **åˆè¨ˆ** | **Â¥3,150/æœˆ** | åˆæœŸãƒ•ã‚§ãƒ¼ã‚ºã¯å®Ÿè³ªClaudeä»£ã®ã¿ |

---

## ğŸ†˜ å›°ã£ãŸã¨ãã®Q&A

**Q: Supabaseã«ãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã•ã‚Œãªã„**
A: Clerk Webhookã®URLãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚
   Clerkãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ Webhooks â†’ ãƒ­ã‚°ã‚’ç¢ºèªã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼å†…å®¹ãŒã‚ã‹ã‚Šã¾ã™ã€‚

**Q: ãƒ¡ãƒ¼ãƒ«ãŒå±Šã‹ãªã„**
A: Resendã®ãƒ‰ãƒ¡ã‚¤ãƒ³èªè¨¼ãŒå®Œäº†ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ï¼ˆç·‘è‰²ã®Verifiedè¡¨ç¤ºï¼‰ã€‚
   Resendãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ Logs ã§ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã§ãã¾ã™ã€‚

**Q: `kuchikomi-farm.com` ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„**
A: Cloudflareã®ãƒãƒ¼ãƒ ã‚µãƒ¼ãƒãƒ¼ãŒNamecheapã«åæ˜ ã•ã‚Œã‚‹ã¾ã§æœ€å¤§48æ™‚é–“ã‹ã‹ã‚Šã¾ã™ã€‚
   https://dnschecker.org ã§ `kuchikomi-farm.com` ã‚’æ¤œç´¢ã—ã¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚

**Q: ç®¡ç†ç”»é¢ã«å…¥ã‚Œãªã„ï¼ˆ403ã‚¨ãƒ©ãƒ¼ï¼‰**
A: Supabaseã§ `profiles.role = 'admin'` ã«è¨­å®šã—ãŸã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚
   SQL Editorã§ `select * from profiles where email = 'ã‚ãªãŸã®ãƒ¡ãƒ¼ãƒ«';` ã‚’å®Ÿè¡Œã—ã¦ç¢ºèªã€‚

**Q: ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã§ããªã„**
A: Vercel â†’ Deployments â†’ å¤±æ•—ã—ãŸãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ Build Logs ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
   ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’Claude Codeã«è²¼ã‚Šä»˜ã‘ã‚‹ã¨è§£æ±ºç­–ã‚’æ•™ãˆã¦ã‚‚ã‚‰ãˆã¾ã™ã€‚

---

## ğŸ“š ç”¨èªé›†ï¼ˆã‚ã‹ã‚‰ãªã„è¨€è‘‰ãŒå‡ºãŸã‚‰è¦‹ã¦ãã ã•ã„ï¼‰

| ç”¨èª | æ„å‘³ |
|-----|------|
| **ãƒ‰ãƒ¡ã‚¤ãƒ³** | ã‚µãƒ¼ãƒ“ã‚¹ã®ä½æ‰€ã€‚`kuchikomi-farm.com` ã®ã“ã¨ |
| **DNS** | ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’ã‚µãƒ¼ãƒãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã«å¤‰æ›ã™ã‚‹ä»•çµ„ã¿ï¼ˆé›»è©±å¸³ã®ã‚ˆã†ãªã‚‚ã®ï¼‰|
| **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹** | ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ãƒ»æ•´ç†ã™ã‚‹å ´æ‰€ã€‚Excelã®è¶…é«˜æ©Ÿèƒ½ç‰ˆ |
| **API** | ãƒ—ãƒ­ã‚°ãƒ©ãƒ åŒå£«ãŒä¼šè©±ã™ã‚‹ãŸã‚ã®çª“å£ |
| **APIã‚­ãƒ¼** | APIã‚’ä½¿ã†ãŸã‚ã®åˆè¨€è‘‰ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ã‚ˆã†ãªã‚‚ã®ï¼‰|
| **Webhook** | ã€Œâ—‹â—‹ãŒèµ·ããŸã‚‰è‡ªå‹•ã§é€šçŸ¥ã—ã¦ã€ã¨ã„ã†ä»•çµ„ã¿ |
| **ãƒ‡ãƒ—ãƒ­ã‚¤** | ä½œã£ãŸã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«å…¬é–‹ã™ã‚‹ä½œæ¥­ |
| **ç’°å¢ƒå¤‰æ•°** | ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«æ¸¡ã™è¨­å®šå€¤ï¼ˆAPIã‚­ãƒ¼ãªã©ï¼‰ã‚’å®‰å…¨ã«ä¿ç®¡ã™ã‚‹ä»•çµ„ã¿ |
| **SSLè¨¼æ˜æ›¸** | URLãŒ `https://` ã«ãªã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ä»•çµ„ã¿ï¼ˆğŸ”’ãƒãƒ¼ã‚¯ï¼‰|
| **ãƒ¬ãƒ¼ãƒˆåˆ¶é™** | ã€Œ1åˆ†é–“ã«â—‹å›ã¾ã§ã€ã¨ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶é™ã—ã¦æ”»æ’ƒã‚’é˜²ãä»•çµ„ã¿ |
| **ãƒ™ã‚¯ã‚¿ãƒ¼** | AIãŒã€Œæ„å‘³ã®è¿‘ã•ã€ã‚’è¨ˆç®—ã™ã‚‹ãŸã‚ã®æ•°å€¤ã®é…åˆ— |
| **RLS** | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®è¡Œå˜ä½ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ï¼ˆRow Level Securityï¼‰|
| **Server Actions** | ã‚µãƒ¼ãƒãƒ¼å´ã§å®Ÿè¡Œã•ã‚Œã‚‹Next.jsã®é–¢æ•°ï¼ˆDBã¸ã®å®‰å…¨ãªã‚¢ã‚¯ã‚»ã‚¹ã«ä½¿ã†ï¼‰|
